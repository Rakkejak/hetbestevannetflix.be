name: Update & Deploy Data

on:
  schedule:
    # Wekelijks op maandag 06:00 Europe/Brussels ≈ 04:00 UTC
    - cron: "0 4 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11", cache: "pip" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: Update all JSONs
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
          UNOGS_API_KEY: ${{ secrets.UNOGS_API_KEY }}
        run: python -u update_all.py
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Update data [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi


      # ---- RUN THE FULL DATA PIPELINE ----
      # We proberen eerst jouw orkestratie-script.
      # Als dat niet bestaat of faalt, draaien we de losse stappen die in je repo staan.
      - name: Generate data (orchestration if available)
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
          TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
        run: |
          set -e
          if [ -f "fetch_data.py" ]; then
            echo "Running fetch_data.py (full pipeline)…"
            python -u fetch_data.py
          else
            echo "fetch_data.py not found — running step-by-step pipeline…"
            if [ -f "fetch_netflix_data.py" ]; then
              python -u fetch_netflix_data.py
            fi
            if [ -f "fetch_imdb_rating.py" ]; then
              python -u fetch_imdb_rating.py
            fi
            if [ -f "deduplicate_netflix_data.py" ]; then
              python -u deduplicate_netflix_data.py
            fi
          fi

      - name: Show repo state (after)
        run: |
          echo "Changed files (staged diff will show below if any):"
          git add -A
          git status --porcelain
          echo "Computing hashes for key JSONs (if present):"
          for f in netflix_data.json netflix_last_month.json netflix_data_partial.json manual_scores.json; do
            if [ -f "$f" ]; then
              echo "$(sha256sum "$f")"
            fi
          done

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main || git rebase --skip
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Update data [skip ci]"
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi


